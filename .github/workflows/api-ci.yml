name: API CI  # ciclo de integración continuo de nuestra API

on:
  push: 
    paths:
      - "api/**"
      - ".github/workflows/api-ci.yml"

defaults:
  run:
    working-directory: ./api

jobs:
  linter:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci  # instala dependencias
      - run: npm run lint  # corre pruebas estáticas

  unit-test:
    runs-on: macos-latest
    steps:  
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci  # instala dependencias
      - run: npm run test  # corre pruebas unitarias

  e2e:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install MongoDB
        run: |
          brew tap mongodb/brew
          brew install mongodb-community@6.0
      - name: Start MongoDB
        run: |
          brew services start mongodb/brew/mongodb-community
          sleep 5  # espera a que Mongo esté listo
      - run: npm ci  # instala dependencias
      - name: Run E2E tests
        run: npm run test:e2e
        env:
          MONGO_DB_NAME: demo_e2e
          MONGO_URL: mongodb://localhost:27017/demo_e2e
